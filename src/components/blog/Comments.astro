---
const GISCUS_REPO_ID = 'R_kgDORRNy9A';
const GISCUS_CATEGORY_ID = 'DIC_kwDORRNy9M4C2hyC';
const isConfigured = Boolean(GISCUS_REPO_ID && GISCUS_CATEGORY_ID);

const giscusBootstrap = `
(function () {
  var CONTAINER_ID = 'giscus-container';

  function getTheme() {
    return document.documentElement.classList.contains('dark') ? 'dark' : 'light';
  }

  function renderGiscus() {
    var container = document.getElementById(CONTAINER_ID);
    if (!container) return;
    if (container.querySelector('iframe.giscus-frame')) return;

    container.innerHTML = '';
    var script = document.createElement('script');
    script.src = 'https://giscus.app/client.js';
    script.async = true;
    script.crossOrigin = 'anonymous';

    script.setAttribute('data-repo', 'ToxicantX/eyes-night');
    script.setAttribute('data-repo-id', 'R_kgDORRNy9A');
    script.setAttribute('data-category', 'Ideas');
    script.setAttribute('data-category-id', 'DIC_kwDORRNy9M4C2hyC');
    script.setAttribute('data-mapping', 'pathname');
    script.setAttribute('data-strict', '0');
    script.setAttribute('data-reactions-enabled', '1');
    script.setAttribute('data-emit-metadata', '0');
    script.setAttribute('data-input-position', 'bottom');
    script.setAttribute('data-lang', 'zh-CN');
    script.setAttribute('data-theme', getTheme());

    container.appendChild(script);
  }

  function syncTheme() {
    var iframe = document.querySelector('iframe.giscus-frame');
    if (!iframe || !iframe.contentWindow) return;

    iframe.contentWindow.postMessage(
      {
        giscus: {
          setConfig: {
            theme: getTheme(),
          },
        },
      },
      'https://giscus.app'
    );
  }

  renderGiscus();
  setTimeout(syncTheme, 400);

  document.addEventListener('astro:after-swap', function () {
    renderGiscus();
    setTimeout(syncTheme, 300);
  });

  new MutationObserver(syncTheme).observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['class'],
  });
})();
`;
---

<section class="max-w-3xl mx-auto mt-12 px-4 sm:px-6">
  <h3 class="text-xl font-semibold mb-4">评论</h3>
  {
    isConfigured ? (
      <div class="rounded-xl border border-gray-200 dark:border-slate-700 p-3 bg-white/80 dark:bg-slate-900/40">
        <div id="giscus-container" />
        <script is:inline set:html={giscusBootstrap} />
      </div>
    ) : (
      <p class="text-muted">评论系统未配置。</p>
    )
  }
</section>
